[quad_gantry_level]
gantry_corners:
    -60,-10
    410,395
## Probe points adjusted for 325mm length
points:
    50,25
    50,300
    300,300
    300,25
speed: 200
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.0075
max_adjust: 10

[bed_mesh]
speed: 600
zero_reference_position: 175, 175  
horizontal_move_z: 5
mesh_min: 20, 20
mesh_max: 330, 310
probe_count: 50,50
adaptive_margin: 5
algorithm: bicubic
mesh_pps: 2,2                # Number of supplementary sampling points
bicubic_tension: 0.2         # Algorithmic interpolation don't move
faulty_region_1_min:20,20
faulty_region_1_max: 45.3,49.6

[gcode_macro homing_override_config]
variable_sensorless_x: False
variable_sensorless_y: False
variable_homing_rebound_y: 8
variable_stepper_driver: "tmc5160"
variable_homing_current: 0.49
gcode:

[homing_override]
axes: xyz
gcode:
  #_INITIALIZE_FROM_DETECTED_TOOL
  DETECT_ACTIVE_TOOL_PROBE
  _HOME AXIS="{rawparams|replace(' ', '')}"
  
[gcode_macro _HOME]
variable_shuttle_endstop_x: 132
variable_shuttle_endstop_y: 323
variable_shuttle_tool_number: -1
gcode:
  {% set axes = params.AXIS|default("") %}
  {% set home_all = ('X' not in axes and 'Y' not in axes and 'Z' not in axes) %}  
  
  {% if printer.tool_probe_endstop.active_tool_number == -1 %}
    SET_ACTIVE_TOOL_PROBE T={shuttle_tool_number}
    # There is no tool loaded, do toolless homing
    RESPOND TYPE=echo MSG='No active tool detected ({printer.probe.active_tool_number}), doing toolless homing'

    # Can't move Z first because the shuttle needs to be over the probe
    {% if home_all or 'Y' in axes %}
      G90
      G28 Y            
    {% endif %} 
    
    {% if home_all or 'X' in axes %}
       G90
       G28 X   
    {% endif %}
   
    # move to the shuttle probe endstop and home Z
    {% if home_all or 'Z' in axes %}
      G90
      G0 X{shuttle_endstop_x} Y{shuttle_endstop_y} F12000
      G28 Z

      G0 Z10 F12000
      _MOVE_TO_CENTER
      _ADJUST_Z_HOME_FOR_TOOL_OFFSET
    {% endif %}
    
  {% else %}
    # There is a tool loaded, do homing as normal
    RESPOND TYPE=echo MSG='Tool {printer.probe.active_tool_number} detected, homing as normal.'
    
    INITIALIZE_TOOLCHANGER T={printer.probe.active_tool_number}
    # ----------------------------
    # DO YOUR NORMAL TOOL HOMING HERE BUT USE "in axes" instead of "in params" to check whether x, y, z is present because we're in a gcode macro and not in the G28 override you can't specify params with values
    # ----------------------------   
      
    {% set uses_tool_probe = printer["tool_probe_endstop"] is defined %}
  
    {% if uses_tool_probe and printer.probe.last_query %}
      RESPOND TYPE=error MSG='Z Probe triggered, cannot home.'
    {% else %}
      SET_GCODE_OFFSET X=0.0 Y=0.0 Z=0.0
      {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
      {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
      {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}
  
      {% set config = printer["gcode_macro homing_override_config"] %}
  
  
      G90 ; absolute mode
      {% if 'z' not in printer.toolhead.homed_axes %}
        SET_KINEMATIC_POSITION Z=0
        G0 Z10 F1000
      {% elif printer.toolhead.position[2]|float < 10 %}
        G0 Z10 F1000
      {% endif %}
  
      {% if home_all or 'Y' in params or 'X' in params %}
        {% if config.sensorless_y %}
          _SENSORLESS_HOME AXIS=Y
        {% else %}
          G28 Y
        {% endif %}
        G0 Y{ max_y - config.homing_rebound_y } F6000
      {% endif %}
  
      {% if home_all or 'X' in params %}
        {% if config.sensorless_x %}
          _SENSORLESS_HOME AXIS=X
        {% else %}
          G28 X
        {% endif %}
        G0 X{ max_x - 10} F6000
      {% endif %}
  
      {% if home_all or 'Z' in params %}
        
        G90 ; absolute mode
        _MOVE_TO_CENTER
        G28 Z
        
        {% if uses_tool_probe %}
          _ADJUST_Z_HOME_FOR_TOOL_OFFSET
        {% endif %}
  
        G0 Z10 F1000
      {% endif %}
      _APPLY_ACTIVE_TOOL_GCODE_OFFSETS
      M400
    {% endif %}
  {% endif %}




[gcode_macro _SENSORLESS_HOME]
variable_homing_current: 0.45
gcode:
  {% set axis = params.AXIS|default('X')|string %}
  
  RESPOND TYPE=echo MSG="Setting homing voltage:{homing_current}"
  # Always use consistent run_current on A/B steppers during sensorless homing
  {% set RUN_CURRENT_X = printer.configfile.settings['tmc5160 stepper_x'].run_current|float %}
  {% set RUN_CURRENT_Y = printer.configfile.settings['tmc5160 stepper_y'].run_current|float %}
  SET_TMC_CURRENT STEPPER=stepper_x CURRENT={homing_current}
  SET_TMC_CURRENT STEPPER=stepper_y CURRENT={homing_current}
  {% if 'tmc5160 stepper_x1' in printer.configfile.settings %}
    {% set RUN_CURRENT_X1 = printer.configfile.settings['tmc5160 stepper_x1'].run_current|float %}
    SET_TMC_CURRENT STEPPER=stepper_x1 CURRENT=0.1
  {% endif %}
  {% if 'tmc5160 stepper_y1' in printer.configfile.settings %}
    {% set RUN_CURRENT_Y1 = printer.configfile.settings['tmc5160 stepper_y1'].run_current|float %}
    SET_TMC_CURRENT STEPPER=stepper_y1 CURRENT=0.1
  {% endif %}

  # Home
  G28 {axis|upper}
    
  # Wait just a secondâ€¦ (give StallGuard registers time to clear)
  G4 P1000
  # Set current during print
  SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
  SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
  {% if 'tmc5160 stepper_x1' in printer.configfile.settings %}
    SET_TMC_CURRENT STEPPER=stepper_x1 CURRENT={RUN_CURRENT_X1}
  {% endif %}
  {% if 'tmc5160 stepper_y1' in printer.configfile.settings %}
    SET_TMC_CURRENT STEPPER=stepper_y1 CURRENT={RUN_CURRENT_Y1}
  {% endif %}


[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing: _QUAD_GANTRY_LEVEL
gcode:
  {% if printer.tool_probe_endstop.active_tool_number == -1 %}
      
      ENSURE_T0       
  {% endif %}
  _QUAD_GANTRY_LEVEL RETRY_TOLERANCE=0.06


; Depending on the selected tool at the time of homing, the physical Z endstop position is offset.
; This corrects for that using current tool offset.
[gcode_macro _ADJUST_Z_HOME_FOR_TOOL_OFFSET]
variable_shuttle_tool_number: -100
gcode:
    G90 ; absolute mode
    G0 Z10 F1000
    {% if (printer.probe.active_tool_number | int) == shuttle_tool_number %}
      {% set probe_z_offset = printer.tool_probe_endstop.active_tool_probe_z_offset %}
      SET_KINEMATIC_POSITION Z={10.0+probe_z_offset|float}
    {% else %}
      {% set tool = printer.toolchanger.tool %}
      {% if tool %}
         {% set tool_z_offset = printer[tool].gcode_z_offset %}
         {% set probe_z_offset = printer.tool_probe_endstop.active_tool_probe_z_offset %}
         SET_KINEMATIC_POSITION Z={10.0+tool_z_offset|float+probe_z_offset|float}
      {% endif %}
    {% endif %}

[gcode_macro _APPLY_ACTIVE_TOOL_GCODE_OFFSETS]
gcode:
    ; Apply gcode offsets
    {% set tool = printer.toolchanger.tool %}
    {% if tool %}
      SET_GCODE_OFFSET X={printer[tool].gcode_x_offset} Y={printer[tool].gcode_y_offset} Z={printer[tool].gcode_z_offset}
    {% endif %}

[gcode_macro TOOL_BED_MESH_CALIBRATE]
gcode:
      {% set tool_z_offset = printer[printer.toolchanger.tool].gcode_z_offset %}
      G90 ; absolute mode
      G0 Z10 F1000
      # Bed mesh knows about the probe offset, but not about the tool offset.
      SET_KINEMATIC_POSITION Z={10.0-tool_z_offset|float}
      BED_MESH_CALIBRATE
      G0 Z10 F1000
      SET_KINEMATIC_POSITION Z={10.0+tool_z_offset|float}
      
[gcode_macro _MOVE_TO_CENTER]
gcode:
  {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
  {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
  {% if "xyz" not in printer.toolhead.homed_axes %}
    G28
  {% endif %}
  G90 ; absolute mode
  G0 X{max_x//2} Y{max_y//2} F12000

[gcode_macro ENSURE_T0]
gcode:
     DETECT_ACTIVE_TOOL_PROBE
     _ENSURE_IMPL

[gcode_macro _ENSURE_IMPL]
gcode:
   {% if (printer.probe.active_tool_number | int) != 0 %}
      {% if "xyz" not in printer.toolhead.homed_axes %}
          G28
      {% endif %}      
      T0
   {% endif %}
