[gcode_macro SEARCH]
description: Usage: SEARCH [I=<include>] [E=<exclude>]
# edges a hair clearer
variable_color_box_border: "rgb(52,52,60)"

# separate cyan roles just enough
variable_color_path: "rgba(110, 216, 230, 1)"   # keep as-is (sky)
variable_color_key:  "rgba(49, 132, 221, 1)"   # slightly deeper blue

variable_color_category: "rgb(137,207,240)"

# leave these as you had them (they read well)
variable_color_val:  "rgb(240,240,240)"
variable_color_typ:  "rgb(160,160,160)"
variable_color_match:"rgb(255,110,180)"
variable_font_size:        "0.9em"
variable_max_depth:        5
variable_search_sep:       "°"
variable_long_limit:       100
variable_timeout:          10.0   # timeout after which to exit early.
gcode:
    ; ======================= STYLES & HELPER JINJA MACROS ==========================
    {%- set base_style = "style='font-size:" ~ font_size ~ "; margin-bottom:3px;'" -%}
    {%- set box_style = "style='font-size:" ~ font_size ~ "; background-color:" ~ color_box_bg ~ "; border:1px solid " ~ color_box_border ~ "; border-radius:4px; padding:2px; margin-top:2px;'" -%}
    {%- set raw_search = params.I|default("") -%}
    {%- set raw_search = params.S if S in params and not raw_search else raw_search -%}
    {%- set sections = {'gcode_commands': [], 'user_macros': [], 'config_templates': [], 'config_settings': [], 'other': [], 'display_templates':[]} -%}
    {%- set ns = namespace(queue=[], results=[]) -%}
    {%- set output = [] -%}
    
    {%- set include_terms = raw_search.lower().split(search_sep) -%}
    {%- set exclude_str = params.E|default("") -%}
    {%- set exclude_terms = (exclude_str|lower).split(search_sep) -%}
    {%- set depth_limit = params.MAX_DEPTH|default(max_depth)|int -%}
    
    {%- for k in printer -%}
        {%- set _ = ns.queue.append({'path': k, 'obj': printer[k], 'depth': 1}) -%}
    {%- endfor -%}

    #---< html escaping, html shorts
    {%- macro _escp(any) -%}{any|string|e|replace('\r', '')|replace('\n', '<br>')}{%- endmacro -%}
    {%- macro _span(color, txt) -%}{"<span style='color:" ~ color ~ "'>" ~ txt ~ "</span>"}{%- endmacro -%}
    {%- macro _summary(summary, details) -%}{"<details " ~ base_style ~ "><summary>" ~ summary ~ "</summary>" ~ details ~ "</details>"}{%- endmacro -%}

    #---< highlight resutls
    {%- macro _highlight_text(text, terms, color) -%}
        {%- set ns = namespace(output=text|string) -%}
        {%- for term in terms if term and term in ns.output|lower -%}
            {%- set idx = (ns.output|lower).find(term) -%}
            {%- if idx != -1 -%}
                {%- set ns.output = ns.output[:idx] ~ _span(color, ns.output[idx:idx + term|length]) ~ ns.output[idx + term|length:] -%}
            {%- endif -%}
        {%- endfor -%}
        {ns.output}
    {%- endmacro -%}


    #---< helper: creates a compact summary of a list if it contains simple items
    {%- macro _summarize_sequence(seq) -%}
        {%- set ns = namespace(summary='[', is_simple=True) -%}
        {%- for item in seq -%}
            {%- if item is mapping or (item is sequence and item is not string) -%}
                {%- set ns.is_simple = False -%}
            {%- endif -%}
        {%- endfor -%}
        {%- if ns.is_simple -%}
            {%- for item in seq -%}
                {%- set ns.summary = ns.summary ~ _escp(item) ~ ', ' -%}
            {%- endfor -%}
            {%- if ns.summary|length > 2 -%}{%- set ns.summary = ns.summary[:-2] -%}{%- endif -%}
            {%- set ns.summary = ns.summary ~ ']' -%}
            {%- if ns.summary|length > long_limit|int -%}{%- set ns.summary = ns.summary[:long_limit|int] ~ '...]' -%}{%- endif -%}
            {ns.summary}
        {%- endif -%}
    {%- endmacro -%}

    #---< helper: build one <div> line for a child entry
    {%- macro _append_child(list_ref, key, value) -%}
        {%- if value is not none and not (value is sameas printer) -%}
            {%- set key_html  = _span(color_key, key) -%}
            
            {%- set line = namespace(html='') -%}

            {%- if key == 'gcode' and value is string and value|trim -%}
                {%- set gcode_item = {'path': key, 'obj': value} -%}
                {%- set line.html = _render_gcode(gcode_item) -%}

            {%- elif value is mapping -%}
                {%- set type_html = _span(color_typ, "(" ~ value.__class__.__name__ ~ ")") -%}
                {%- set line.html = "<div>" ~ key_html ~ ": " ~ type_html ~ "</div>" -%}

            {%- elif value is sequence and value is not string -%}
                {%- set summary_text = _summarize_sequence(value) | trim -%}
                {%- set val_html = "" -%}
                {%- if summary_text -%}
                    {%- set val_html = _span(color_val, _highlight_text(summary_text, include_terms, color_match)) -%}
                {%- endif -%}
                {%- set type_html = _span(color_typ, "(list)") -%}
                {%- set line.html = "<div>" ~ key_html ~ ": " ~ val_html ~ " " ~ type_html ~ "</div>" -%}
                
            {%- else -%}
                {%- set val_html = _highlight_text(_escp(value), include_terms, color_match) -%}
                {%- set type_html = _span(color_typ, "(" ~ value.__class__.__name__ ~ ")") -%}
                {%- set line.html = "<div>" ~ key_html ~ ": " ~ _span(color_val, val_html) ~ " " ~ type_html ~ "</div>" -%}
            {%- endif -%}

            {%- if line.html -%}
                {%- set _ = list_ref.append(line.html) -%}
            {%- endif -%}
        {%- endif -%}
    {%- endmacro -%}

    #---< categorization for section sorting/gcode formatting
    {%- macro _get_category(item) -%}
        {%- if item.path.startswith('gcode_macro') -%}
            { 'user_macros' }
        {%- elif item.path.startswith('gcode.commands') -%}
            { 'gcode_commands' }
        {%- elif (item.obj is string and ('{%' in item.obj or '{' in item.obj)) or item.path.startswith('configfile.settings.delayed_gcode') or (item.path.startswith('configfile.settings.') and item.path.endswith('_gcode')) -%}
            { 'config_templates' }
        {%- elif item.path.startswith('configfile.settings.display_template') -%}
            { 'display_templates' }
        {%- elif item.path.startswith('configfile.settings') -%}
            { 'config_settings' }
        {%- else -%}
            { 'other' }
        {%- endif -%}
    {%- endmacro -%}
    #-------------------------------------- RENDERS --------------------------------------
    #---< gcode render
    {%- macro _render_gcode(item) -%}
        {%- set indent_keywords = ['{%if', '{%for', '{%el', '{%macro'] -%}
        {%- set outdent_keywords = ['{%end', '{%el'] -%}
        {%- set ns_format = namespace(lines=[], indent=0, in_multiline=False) -%}

        {%- for line in item.obj.split('\n') -%}
            {%- set stripped = line|trim -%}
            {%- if stripped -%}
                {%- set normalized_line = stripped|replace(' ', '')|replace('-', '') -%}
                {%- set has_indent_keyword = (indent_keywords|select('in', normalized_line)|list|length) > 0 -%}
                {%- set has_outdent_keyword = (outdent_keywords|select('in', normalized_line)|list|length) > 0 -%}

                {%- if ns_format.in_multiline and '%}' in stripped -%}
                    {%- set ns_format.in_multiline = False -%}
                {%- endif -%}

                {%- if has_outdent_keyword -%}
                    {%- set ns_format.indent = [ns_format.indent - 1, 0]|max -%}
                {%- endif -%}

                {%- set total_indent = ns_format.indent + (1 if ns_format.in_multiline else 0) -%}
                {%- set _ = ns_format.lines.append('  ' * 2 * total_indent ~ line|e) -%}

                {%- if has_indent_keyword and not has_outdent_keyword or normalized_line.startswith('{%else') -%}
                    {%- set ns_format.indent = ns_format.indent + 1 -%}
                {%- endif -%}
                
                {%- if not ns_format.in_multiline and stripped.startswith('{%') and not '%}' in stripped -%}
                    {%- set ns_format.in_multiline = True -%}
                {%- endif -%}
            {%- endif -%}
        {%- endfor -%}
        {%- set gcode = _highlight_text(ns_format.lines|join('<br>'), include_terms, color_match) -%}
        {%- set details = "<div " ~ box_style ~ "><div style='white-space:pre; font-family:monospace; overflow-x:auto;'>" ~ gcode ~ "</div></div>" -%}
        {_summary(_highlight_text(item.path, include_terms, color_match), details)}
    {%- endmacro -%}

    #---< description/misc render
    {%- macro _render_long_string(item) -%}
        {%- set h_path = _highlight_text(item.path, include_terms, color_match) -%}
        {%- set h_val  = _highlight_text(_escp(item.obj), include_terms, color_match) -%}
        {_summary(h_path, "<div " ~ box_style ~ ">" ~ h_val ~ "</div>")}
    {%- endmacro -%}

    #---< simple value (int, none, float etc...) render
    {%- macro _render_primitive(item) -%}
        {%- set h_path = _highlight_text(item.path, include_terms, color_match) -%}
        {%- set safe_val_str = _escp(item.obj) -%}
        {%- set val = _highlight_text(safe_val_str, include_terms, color_match) -%}
        {%- set h_type = _highlight_text("(" ~ item.obj.__class__.__name__ ~ ")", include_terms, color_typ) -%}
        { "<div " ~ base_style ~ ">" ~ h_path ~ ": " ~ _span(color_val, val) ~ " " ~ _span(color_typ, h_type) ~ "</div>" }
    {%- endmacro -%}
    

    #---< render for mappings AND lists
    {%- macro _render_mapping(item) -%}
        {%- set h_path = _highlight_text(item.path, include_terms, color_match) -%}
        {%- set children = [] -%}

        #---< iterate over mapping items for dict-like objects
        {%- if item.obj is mapping -%}
            {%- set kv = [] -%}
            {%- for k in item.obj -%} # temp stringify keys, so python sort doesnt piss itself when we have int keys.
                {%- set _ = kv.append([k|string, k]) -%}
            {%- endfor -%}

            {%- for sk, k in kv|sort(attribute=0) -%}
                {%- set _ = _append_child(children, k, item.obj[k]) -%}
            {%- endfor -%}
        #---< [NEW] iterate over sequence items for list/tuple objects
        {%- elif item.obj is sequence and item.obj is not string -%}
             {%- for i in range(item.obj|length) -%}
                {%- set value = item.obj[i] -%}
                {%- set _ = _append_child(children, '[' ~ i ~ ']', value) -%}
            {%- endfor -%}
        #---< fall back to dir() for other complex python/klipper objects
        {%- else -%}
            {%- for key in item.obj.__dir__()|sort -%}
                {%- if not key.startswith('__') -%}
                    {%- set value = item.obj|attr(key) -%}
                    {%- set _ = _append_child(children, key, value) -%}
                {%- endif -%}
            {%- endfor -%}
        {%- endif -%}

        #---< wrap the collected children in a collapsible details tag
        {%- set summary = h_path ~ " " ~ _span(color_typ, "(" ~ item.obj.__class__.__name__ ~ ")") -%}
        {%- set details = "<div " ~ box_style ~ ">" ~ (children|join) ~ "</div>" -%}
        {_summary(summary, details)}
    {%- endmacro -%}

    {%- macro _render_result(item) -%}
        {%- set cls = item.obj.__class__.__name__ -%}
        #---< Check category first for reliable G-Code formatting
        {%- if item.category == 'config_templates' -%}
            {_render_gcode(item)}
            
        #---< raw gcode text? >
        {%- elif cls == 'str' and ('{%' in item.obj) -%}
            {_render_gcode(item)}

        #---< any dict-like OR non-trivial object gets a field table >
        {%- elif item.obj is mapping or cls == 'tuple' or cls not in ['str', 'int', 'float', 'bool', 'NoneType'] -%}
            {_render_mapping(item)}

        #---< long plain strings collapse to <details> >
        {%- elif cls == 'str' and item.obj|length > long_limit|int -%}
            {_render_long_string(item)}

        #---< simple primitives (numbers, short strings, etc.) >
        {%- else -%}
            {_render_primitive(item)}
        {%- endif -%}
    {%- endmacro -%}


    #---------------------------- ACTUAL SERACH --------------------------   
    {%- if not raw_search -%}
        {action_raise_error("Usage: SEARCH [I=<include>] [E=<exclude>]")}
    {%- endif -%}
    {% set reactor = printer.printer.reactor %}
    { action_respond_info("Starting search for '" ~ raw_search|e ~ "'...") }
    {%- set start_time = reactor.monotonic()|float -%}

    {%- for i in range(40000) if ns.queue -%}
        {%- if i % 5000 == 0 and reactor.monotonic()|float - start_time > timeout|float -%}
            {%- set _ = output.append('<br>' ~ _span('red', "Search aborted after " ~ (reactor.monotonic() - start_time) ~ " s with " ~ ns.queue|length ~ " remaining in the que")) -%}
            {%- set _ = ns.queue.clear() -%}
        {%- elif ns.results|length > 249 -%}
            {%- set _ = output.append('<br>' ~ _span('red', "Search aborted after " ~ (reactor.monotonic() - start_time) ~ " s (capped at 250 results, please specifcy)")) -%}
            {%- set _ = ns.queue.clear() -%}
        {%- else -%}
            {%- set item = ns.queue.pop(0) -%}
            {%- set val_str = item.obj|string if not (item.obj is mapping) else "" -%}
            {%- set combined = (item.path ~ " " ~ val_str)|lower -%}
            {%- set keep = namespace(v=True) -%}
            
            {%- for term in include_terms if term and term not in combined -%}{%- set keep.v = False -%}{%- endfor -%}
            {%- for term in exclude_terms if term and term     in combined -%}{%- set keep.v = False -%}{%- endfor -%}
            {%- if 'configfile.config' in item.path -%}{%- set keep.v = False -%}{%- endif -%} #---< duplicate but all values are strings lol
            
            {%- if keep.v -%}
                {%- set _ = ns.results.append({'path': item.path, 'html': _render_result(item), 'category': _get_category(item)}) -%}
            #---< dont keep? keep searching into it.
            {%- elif item.depth < depth_limit -%}
                {%- if item.obj is mapping -%} #---< mapping
                    {%- for k in item.obj -%}{%- set _ = ns.queue.append({'path': item.path ~ "." ~ k, 'obj': item.obj[k], 'depth': item.depth + 1}) -%}{%- endfor -%}
                {%- elif item.obj is sequence and item.obj is not string -%} #---< or list?
                    {%- for i in range(item.obj|length) -%}{%- set _ = ns.queue.append({'path': item.path ~ "[" ~ i ~ "]", 'obj': item.obj[i], 'depth': item.depth + 1}) -%}{%- endfor -%}
                {%- endif -%}
            {%- endif -%}
        {%- endif -%}
    {%- endfor -%}
    #---------------------------- DISPLAY SEARCH --------------------------  
    {%- if not ns.results -%}
        RESPOND MSG="No matches found for '{raw_search|e}'"
    {%- else -%}
        {%- for item in ns.results|sort(attribute='path') -%}
            {%- set _ = sections[item.category].append(item.html) -%}
        {%- endfor -%}      
        {%- set category_map = [
            ('live printer objects',    sections.other),
            ('macro variables etc',     sections.user_macros),
            ('printer config',          sections.config_settings), 
            ('display templates',       sections.display_templates),
            ('gcode templates',         sections.config_templates),
            ('useless (command help)',  sections.gcode_commands)
            ] -%}
        
        
        {%- for name, items in category_map if items -%}
            {%- set summary = "<summary style='color:" ~ color_category ~ "; font-weight:bold;'>" ~ name ~ " (" ~ items|length ~ " matches)</summary>" -%}
            {%- set _ = output.append("<details>" ~ summary ~ (items|join) ~ "</details>") -%}
        {%- endfor -%}
        {% set _ = action_respond_info("Found " ~ ns.results|length ~ "matches for '" ~ raw_search|e ~ "':" ~ output|join ) %}
    {%- endif -%}








[gcode_macro PRINT_PRINTER_PATH]
description: "prints the contents of printer.$PATH$, use FORCE=1 to print longer messages    Lightweight to dump objects while executing macros."
variable_cutoff: 80
variable_key_cutoff: 50

# Color scheme variables
variable_color_key: "primary--text text--lighten-5"
variable_color_value: "white"
variable_color_container: "warning--text text--darken-1"
variable_color_special: "success--text text--darken-1"
variable_color_text: "primary--text text--lighten-4"
variable_color_error: "error--text text--darken-1"
variable_color_hint: "secondary--text text--lighten-1"
variable_color_type: "accent--text text--lighten-4"
variable_color_index: "info--text text--lighten-3"
variable_color_bool: "success--text text--darken-2"
variable_color_bool_false: "error--text text--darken-2"
variable_color_none: "secondary--text text--darken-4"
variable_color_number: "info--text text--lighten-1"
variable_color_string: "primary--text text--lighten-1"
variable_color_object: "accent--text text--darken-4"
gcode:
    {%- set path_str = params.PATH|default("") -%}

    {%- set path_str = path_str.replace('["', '.') -%}
    {%- set path_str = path_str.replace("']['", '.') -%}
    {%- set path_str = path_str.replace("']", "") -%}
    {%- set path_str = path_str.replace('"]', "") -%}
    {%- set path_str = path_str.replace("[", ".") -%}
    {%- set path_str = path_str.replace("]", "") -%}
    
    {%- if (path_str|lower).startswith("printer.") -%} {%- set path_str = path_str[8:] -%} {%- endif -%}
    {%- if (path_str|lower).startswith("printer") -%} {%- set path_str = path_str[7:] -%} {%- endif -%}

    {%- set parts = path_str.split('.') -%}
    
    {%- set ns = namespace(current=printer, invalid=False, lines=[]) -%}
    # Traverse each part of the path
    {%- for part in parts if not ns.invalid -%}
        {%- set keys = ns.current|list -%}
        {%- if part in keys -%}
            {%- set ns.current = ns.current[part] -%}
        {%- else -%}
            {%- set part_escaped = part.replace("'", "&apos;").replace("\"", "&quot;") -%}
            {%- set original_path_escaped = (params.PATH|default(""))|replace("'", "&apos;")|replace("\"", "&quot;") -%}
            {%- set _ = ns.lines.append("<span class='" ~ color_error ~ "'>Invalid part &apos;" ~ part_escaped ~ "&apos; in path &apos;printer." ~ original_path_escaped ~ "&apos;</span>") -%}
            {%- set ns.invalid = True -%}
        {%- endif -%}
    {%- endfor -%}

    {%- if not ns.invalid -%}
        {%- set type_str = ns.current.__class__.__name__ -%}
        {%- set val_str = ns.current|string -%}
        # Escape path and values for HTML
        {%- set path_escaped = path_str.replace("'", "&apos;").replace("\"", "&quot;") -%}
        {%- set val_escaped = val_str.replace("'", "&apos;").replace("\"", "&quot;") -%}
        # If it’s a simple type
        {%- if type_str not in ('dict', 'list', 'tuple', 'set') -%}
            {%- set value_color = color_value -%}
            {%- if type_str == 'Coord' -%}{%- set value_color = color_special -%}
            {%- elif type_str == 'bool' -%}{%- if val_str == "True" -%}{%- set value_color = color_bool -%}{%- else -%}{%- set value_color = color_bool_false -%}{%- endif -%}
            {%- elif type_str in ['float', 'int'] -%}{%- set value_color = color_number -%}
            {%- elif type_str == 'str' -%}{%- set value_color = color_string -%}
            {%- elif type_str == 'NoneType' -%}{%- set value_color = color_none -%}
            {%- else -%}{%- set value_color = color_object -%}{%- endif -%}
            {%- set _ = ns.lines.append(
               "<span class='" ~ color_text ~ "'>Value at printer." ~ path_escaped ~ ":</span> " ~
               "<span class='" ~ value_color ~ "'>&apos;" ~ val_escaped ~ "&apos;</span> " ~
               "<span class='" ~ color_type ~ "'>(" ~ type_str ~ ")</span>"
            ) -%}
        {%- else -%}
            # Container type (dict, list, etc.)
            {%- set all_keys = ns.current|list -%}
            {%- if all_keys|length > 0 -%}
                {%- set _ = ns.lines.append(
                   "<span class='" ~ color_text ~ "'>Contents of:</span> <span class='" ~ color_key ~ "'>printer." ~ path_escaped ~ "</span>"
                ) -%}
                {%- if params.FORCE|default(false) in ["1","True","true"] -%} {%- set limited_keys = all_keys -%} {%- else -%} {%- set limited_keys = all_keys[:key_cutoff] -%} {%- endif -%}
                {%- for k in limited_keys -%}
                    {%- set raw_val = ns.current[k] -%}
                    {%- set val_type = raw_val.__class__.__name__ -%}
                    {%- set val_str2 = raw_val|string -%}
                    {%- set val_escaped2 = val_str2.replace("'", "&apos;").replace("\"", "&quot;") -%}
                    {%- set val_ns = namespace(trimmed=val_escaped2, truncated_chars=0) -%}

                    {%- if val_str2|length > cutoff and not (params.FORCE|default(false) in ["1","True","true"]) -%}
                        {%- set val_ns.trimmed = val_str2[:cutoff - 3] ~ "..."|replace("'", "&apos;")|replace("\"", "&quot;") -%}
                        {%- set val_ns.truncated_chars = val_str2|length - cutoff + 3 -%}
                    {%- endif -%}
                    {%- set prefix_color = color_key -%}
                    {%- set value_color = color_value -%}
                    {%- set type_color = color_type -%}
                    {%- set hint_color = color_hint -%}
                    # Choose color by type
                    {%- if val_type in ('dict', 'list', 'tuple', 'set') -%}{%- set value_color = color_container -%}
                    {%- elif val_type == 'Coord' -%}{%- set value_color = color_special -%}
                    {%- elif val_type == 'bool' -%}{%- if val_str2 == "True" -%}{%- set value_color = color_bool -%}{%- else -%}{%- set value_color = color_bool_false -%}{%- endif -%}
                    {%- elif val_type in ['float', 'int'] -%}{%- set value_color = color_number -%}
                    {%- elif val_type == 'str' -%}{%- set value_color = color_string -%}
                    {%- elif val_type == 'NoneType' -%}{%- set value_color = color_none -%}
                    {%- else -%}{%- set value_color = color_object -%}{%- endif -%}
                    {%- set k_escaped = (k|string).replace("'", "&apos;").replace("\"", "&quot;") -%}
                    {%- if val_ns.trimmed != val_escaped2 -%}
                        {%- set _ = ns.lines.append(
                           "<span class='" ~ prefix_color ~ "'>" ~ k_escaped ~ ":</span> " ~
                           "<span class='" ~ value_color ~ "'>&apos;" ~ val_ns.trimmed ~ "&apos;</span> " ~
                           "<span class='" ~ type_color ~ "'>(" ~ val_type ~ ")</span> " ~
                           "<span class='" ~ hint_color ~ "'>(cut " ~ (val_ns.truncated_chars|string) ~ " chars)</span>"
                        ) -%}
                    {%- else -%}
                        {%- set _ = ns.lines.append(
                           "<span class='" ~ prefix_color ~ "'>" ~ k_escaped ~ ":</span> " ~
                           "<span class='" ~ value_color ~ "'>&apos;" ~ val_ns.trimmed ~ "&apos;</span> " ~
                           "<span class='" ~ type_color ~ "'>(" ~ val_type ~ ")</span>"
                        ) -%}
                    {%- endif -%}
                    # If it's a Coord, show X/Y/Z/E
                    {%- if val_type == 'Coord' and raw_val is defined -%}
                        {%- for axis in ['x','y','z','e'] -%}
                            {%- set val_axis = raw_val[axis]|default("n/a") -%}
                            {%- set val_axis_type = val_axis.__class__.__name__ -%}
                            {%- set val_axis_str = val_axis|string -%}
                            {%- set val_axis_escaped = val_axis_str.replace("'", "&apos;").replace("\"", "&quot;") -%}
                            {%- set val_color = color_value -%}
                            {%- if val_axis_type == 'bool' -%}{%- if val_axis_str == "True" -%}{%- set val_color = color_bool -%}{%- else -%}{%- set val_color = color_bool_false -%}{%- endif -%}
                            {%- elif val_axis_type in ['float', 'int'] -%}{%- set val_color = color_number -%}
                            {%- elif val_axis_type == 'str' -%}{%- set val_color = color_string -%}
                            {%- elif val_axis_type == 'NoneType' -%}{%- set val_color = color_none -%}
                            {%- else -%}{%- set val_color = color_object -%}{%- endif -%}
                            {%- set _ = ns.lines.append(
                               "<span class='" ~ color_index ~ "'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" ~ k_escaped ~ "." ~ axis ~ ":</span> " ~
                               "<span class='" ~ val_color ~ "'>" ~ val_axis_escaped ~ "</span> " ~
                               "<span class='" ~ color_type ~ "'>(" ~ val_axis_type ~ ")</span>"
                            ) -%}
                        {%- endfor -%}
                    {%- endif -%}
                {%- endfor -%}
                {%- if not (params.FORCE|default(false) in ["1","True","true"]) and all_keys|length > key_cutoff -%}
                    {%- set remaining = all_keys|length - key_cutoff -%}
                    {%- set _ = ns.lines.append("<span class='" ~ color_text ~ "'>... " ~ (remaining|string) ~ " keys. (Use FORCE=1 to print all.)</span>") -%}
                {%- endif -%}
            {%- else -%}{%- set _ = ns.lines.append("<span class='" ~ color_text ~ "'>printer." ~ path_escaped ~ " has no keys or contents.</span>") -%}{%- endif -%}
        {%- endif -%}
    {%- endif -%}
    # Finally, if we have any lines to show, join them into one single response
    {%- set joined_lines = ns.lines|join("<br>") -%}
    {%- if joined_lines -%}
        RESPOND MSG="{joined_lines}"
    {%- endif -%}





[gcode_macro INSPECT_OBJECT]
description: "Usage: INSPECT_OBJECT O=<name> [F=<filter>] [DUNDER=1]"
variable_color_attr:            "rgb(150, 220, 255)"
variable_color_method:          "rgb(130, 255, 150)"
variable_color_private_method:  "rgb(180, 220, 180)"
variable_color_getter:          "rgb(255, 200, 100)"
variable_color_command:         "rgb(255, 160, 122)"
variable_color_val:             "rgb(240, 240, 240)"
variable_color_type:            "rgb(160, 160, 160)"
variable_color_doc:             "rgb(140, 160, 140)"
variable_color_klipper_obj:     "rgba(255, 130, 80, 0.6)"
variable_color_container:       "rgb(210, 180, 255)"
variable_color_arg_self:        "rgb(255, 110, 180)"
variable_color_arg_other:       "rgb(137, 207, 240)"
variable_val_cutoff:            200
variable_font_size:             "0.8em"
gcode:
    {%- set p = printer.printer -%}
    {%- set obj_name = params.O|default(params.OBJECT|default(None)) -%}
    {%- if obj_name is none -%} {action_raise_error("Usage: INSPECT_OBJECT O=<name> [DEPTH=0] [F=<filter>] [DUNDER=1]")} {%- endif -%}

    {% set max_depth = params.DEPTH|default(1)|int %}

    # find the closest match if it didnt exactly match
    {%- set obj = p.lookup_object(obj_name, None) -%}
    {%- if obj is none -%}
        {%- set ns = namespace(best_match_obj=None, best_match_name=None) -%}
        {%- set search_lower = obj_name|lower -%}
        {%- for candidate_name, candidate_obj in p.lookup_objects() if search_lower in candidate_name|lower -%}
            {%- if ns.best_match_name is none or candidate_name|length < ns.best_match_name|length -%}
                {%- set ns.best_match_obj = candidate_obj -%}
                {%- set ns.best_match_name = candidate_name -%}
            {%- endif -%}
        {%- endfor -%}
        {%- if ns.best_match_obj is not none -%}
            {action_respond_info("Object '" ~ obj_name|e ~ "' not found. Using best match: '" ~ ns.best_match_name|e ~ "'")}
            {%- set obj = ns.best_match_obj -%}
            {%- set obj_name = ns.best_match_name -%}
        {%- else -%}
            {action_respond_info("Object '" ~ obj_name|e ~ "' not found. No partial matches found either.")}
            {%- set obj = {} -%}
        {%- endif -%}
    {%- endif -%}

    #-------------------------------------------------------------------------------------------------------------------------------------
    # just small helpers
    {%- macro _span(color, txt) -%}
        {"<span style='color:" ~ color ~ "'>" ~ txt|e ~ "</span>"}
    {%- endmacro -%}
    {%- macro _details(summary, content, is_open=False) -%}
        {"<details" ~ (" open" if is_open else "") ~ "><summary style='cursor:pointer;'>" ~ summary ~ "</summary><div style='padding-left: 20px; border-left: 1px solid rgb(51, 51, 51);'>" ~ content ~ "</div></details>"}
    {%- endmacro -%}
    {%- macro _row(label_html, value_html) -%}
        {"<div style='display: flex; align-items: baseline;'>" ~ label_html ~ value_html ~ "</div>"}
    {%- endmacro -%}

    {% set already_explored_objects = ['printer', 'toolhead', 'main'] %}

    # render values
    {%- macro _render_value(val, as_string=False, depth=0) -%}#{%- macro _render_value(val, as_string=False) -%}
        {%- set type_name = val.__class__.__name__ -%}
        {%- set val_str_raw = val|string -%}
        {%- if as_string -%}
            {%- if val is none -%}None
            {%- elif val is sameas True or val is sameas False -%}{val|string}
            {%- elif val is mapping -%}{"{...}"}
            {%- elif val is sequence and val is not string -%}{"[...]" }
            {%- elif '<' in val_str_raw and 'object at 0x' in val_str_raw -%}{"<" ~ type_name ~ ">"}
            {%- else -%}{ "'" ~ val_str_raw|truncate(30) ~ "'" }
            {%- endif -%}
        {%- else -%}
            {%- if val is none -%} {_span(color_val, 'None') ~ " " ~ _span(color_type, '(NoneType)')}
            {%- elif val is sameas True or val is sameas False -%} {_span(color_val, val|string) ~ " " ~ _span(color_type, '(bool)')}
            {%- elif val is mapping -%}
                {%- set summary = _span(color_container, "(dict, " ~ val|length ~ " items)") -%}
                {%- set items = [] -%}
                {%- for k, v in val.items() -%}
                    {%- set _ = items.append(_row(_span(color_attr, k|string ~ ": "), _render_value(v, False, depth))) -%}
                {%- endfor -%}
                {_details(summary, items|join(''))}
            {%- elif val is sequence and val is not string -%}
                {%- set summary = _span(color_container, "(list, " ~ val|length ~ " items)") -%}
                {%- set items = [] -%}
                {%- for item in val -%}
                    {%- set _ = items.append(_row(_span(color_type, "[" ~ loop.index0 ~ "]: "), _render_value(item, False, depth))) -%}
                {%- endfor -%}
                {_details(summary, items|join(''))}
            {%- elif '<' in val_str_raw and 'object at 0x' in val_str_raw -%}
                {%- set summary = _span(color_klipper_obj, "<" ~ type_name ~ ">") -%}
                {%- if depth >= max_depth or already_explored_objects|select('in', val_str_raw|lower)|list -%}
                    { summary }
                {%- else -%}
                    {%- set rows = [] -%}
                    {%- set _ = already_explored_objects.append(val_str_raw) -%}
                    {%- for an in val.__dir__()|sort if (params.DUNDER or not an.startswith('__')) and rows|length < 100 -%}
                        {%- set subval = val|attr(an) -%}
                        {%- if (subval is not undefined) and (subval is not callable) -%}
                            {%- set _ = rows.append(_row(_span(color_attr, an ~ ": "), _render_value(subval, False, depth + 1))) -%}
                        {%- endif -%}
                    {%- endfor -%}
                    { _details(summary, rows|join('')) }
                {%- endif -%}
            {%- else -%}
                {%- set val_str = val_str_raw -%}
                {%- if val_str|length > val_cutoff -%}{%- set val_str = val_str[:val_cutoff] ~ '…' -%}{%- endif -%}
                { _span(color_val, "'" ~ val_str ~ "'") ~ " " ~ _span(color_type, "(" ~ type_name ~ ")") }
            {%- endif -%}
        {%- endif -%}
    {%- endmacro -%}

    # render method/function + signature
    {%- macro _render_callable(callable_obj, name, color, override_doc=None) -%}
        {%- if callable_obj.__code__.co_varnames is defined -%}
            {%- set signature_html = [] -%}
            {%- set code = callable_obj.__code__ -%}
            {%- set defaults = callable_obj.__defaults__ or () -%}
            {%- set arg_names = code.co_varnames[:code.co_argcount] -%}
            {%- set first_default_idx = arg_names|length - defaults|length -%}
            {%- for i in range(arg_names|length) -%}
                {%- set arg_name = arg_names[i] -%}
                {%- set arg_color = color_arg_self if arg_name == 'self' else color_arg_other -%}
                {%- if i >= first_default_idx -%}
                    {%- set default_val_str = _render_value(defaults[i - first_default_idx], as_string=True) -%}
                    {%- set _ = signature_html.append(_span(arg_color, arg_name) ~ "=" ~ _span(color_val, default_val_str)) -%}
                {%- else -%}
                    {%- set _ = signature_html.append(_span(arg_color, arg_name)) -%}
                {%- endif -%}
            {%- endfor -%}
            {%- set doc = override_doc or callable_obj.__doc__|string|trim -%}
            {%- set full_signature = _span(color, name ~ "(") ~ signature_html|join(', ') ~ _span(color, ")") -%}
            {%- if doc and doc != 'None' -%}
                {%- set doc_html = _span(color_doc, " // " ~ doc|replace('\n', ' ')|truncate(100)) -%}
                {full_signature ~ doc_html}
            {%- else -%}
                {full_signature}
            {%- endif -%}
        {%- else -%}
            {%- set type_name = callable_obj.__class__.__name__ -%}
            {_span(color, name ~ "(i dunno)") ~ _span(color_type, "<" ~ type_name ~ ">")}
        {%- endif -%}
    {%- endmacro -%}

    #-------------------------------------------------------------------------------------------------------------------------------------
    {%- set attributes, public_methods, private_methods, getters, commands, output = [], [], [], [], [], [] -%}
    {%- set filt = params.F|default("")|lower -%}
    {%- set help_strings = {} -%}

    {%- if obj -%}
        # find _help to attatch later
        {%- for attr_name in obj.__dir__() -%}
            {%- if attr_name.startswith('cmd_') and attr_name.endswith('_help') -%}
                {%- set _ = help_strings.update({attr_name|replace('_help', ''): obj|attr(attr_name)}) -%}
            {%- endif -%}
        {%- endfor -%}
        
        # main loop
        {%- for attr_name in obj.__dir__()|sort -%}
            {%- if (not attr_name.startswith('__') or params.DUNDER) and (not filt or filt in attr_name|lower) and not attr_name.endswith('_help') -%}
                {%- set attr_val = obj|attr(attr_name) -%}
                {%- if attr_val.__code__ is defined and attr_val.__code__.co_varnames is defined -%}
                    {%- set doc = help_strings.get(attr_name, None) -%}
                    {%- if attr_name.startswith('get_') -%}
                        {%- set code = attr_val.__code__ -%}
                        {%- if code.co_argcount == 2 and code.co_varnames[1] == 'eventtime' or code.co_argcount == 1 -%}
                            {%- set return_val = attr_val(p.get_reactor().monotonic()) if code.co_argcount != 1 else attr_val() -%}
                            {%- set status_html = _render_callable(attr_val, attr_name, color_getter) ~ ': ' ~ _render_value(return_val) -%}
                            {%- set _ = getters.append( "<div style='display: flex; align-items: baseline;'>" ~ status_html ~ "</div>") -%}
                        {%- else -%}
                            {%- set _ = getters.append(_render_callable(attr_val, attr_name, color_getter, doc)) -%}
                        {%- endif -%}
                    {%- elif attr_name.startswith('cmd_') -%} {%- set _ = commands.append(       _render_callable(attr_val, attr_name, color_command,        doc)) -%}
                    {%- elif attr_name.startswith('_') -%}    {%- set _ = private_methods.append(_render_callable(attr_val, attr_name, color_private_method, doc)) -%}
                    {%- else -%}                              {%- set _ = public_methods.append( _render_callable(attr_val, attr_name, color_method,         doc)) -%}
                    {%- endif -%}
                {%- elif attr_val is callable -%}
                    {%- set type_name = attr_val.__class__.__name__ -%}
                    {%- set fallback_html = "<div>" ~ _span(color_private_method, attr_name ~ "(i dunno)") ~ _span(color_type, "<"|e ~ type_name) ~ ">"|e ~ "</div>" -%}
                    {%- set _ = private_methods.append(fallback_html) if attr_name.startswith('_') else public_methods.append(fallback_html) -%}
                {%- else -%}
                    {%- set attr_html = "<div style='display: flex; align-items: baseline;'>" ~ _span(color_attr, attr_name ~ ": ") ~ _render_value(attr_val) ~ "</div>" -%}
                    {%- set _ = attributes.append(attr_html) -%}
                {%- endif -%}
            {%- endif -%}
        {%- endfor -%}
    {%- endif -%}
    
    {% set out = [ (color_getter,         'Getters',         getters),
                   (color_command,        'Commands',        commands),
                   (color_method,         'Public Methods',  public_methods),
                   (color_private_method, 'Private Methods', private_methods) 
                ] %}
    {%- set _ = output.append(_details(_span(color_attr, "Attributes (" ~ attributes|length ~ ")"), attributes|sort|join(''))) if attributes else '' -%}
    {%- for col, name, pile in out if pile -%}
        {%- set open = pile|length <= 5 -%}
        {%- set content = "<div>" ~ pile|sort|join('</div><div>') ~ "</div>" -%}
        {%- set _ = output.append(_details(_span(col, name ~ " (" ~ pile|length ~ ")"), content, open)) -%}
    {%- endfor -%}
    #--- Assemble and Print Report ---

    {%- set title = "<b>Inspecting Object: '" ~ obj_name|e ~ "'</b>" -%}
    {%- set report = _details(title, output|join(''), is_open=True) -%}
    # may klipper forgive me for shitting literal megabytes to the console in one respond
    {action_respond_info("<div style='font-size: " ~ font_size ~ ";'>" ~ report ~ "</div>") if obj else ''} #font-family: monospace; 